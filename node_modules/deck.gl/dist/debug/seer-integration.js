'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.updateLayerInSeer = exports.initLayerInSeer = exports.logPayload = exports.removeLayerInSeer = exports.seerInitListener = exports.layerEditListener = exports.applyPropOverrides = exports.setPropOverrides = undefined;

var _seer = require('seer');

var _seer2 = _interopRequireDefault(_seer);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

/**
 * Recursively set a nested property of an object given a properties array and a value
 */
var recursiveSet = function recursiveSet(obj, path, value) {
  if (!obj) {
    return;
  }

  if (path.length > 1) {
    recursiveSet(obj[path[0]], path.slice(1), value);
  } else {
    obj[path[0]] = value;
  }
};

var overrides = new Map();

/**
 * Create an override on the specify layer, indexed by a valuePath array.
 * Do nothing in case Seer as not been initialized to prevent any preformance drawback.
 */
var setPropOverrides = exports.setPropOverrides = function setPropOverrides(id, valuePath, value) {
  if (!_seer2.default.isReady()) {
    return;
  }

  if (!overrides.has(id)) {
    overrides.set(id, new Map());
  }

  var props = overrides.get(id);
  props.set(valuePath, value);
};

/**
 * Get the props overrides of a specific layer if Seer as been initialized
 * Invalidates the data to be sure new ones are always picked up.
 */
var applyPropOverrides = exports.applyPropOverrides = function applyPropOverrides(props) {
  if (!_seer2.default.isReady() || !props.id) {
    return;
  }

  var overs = overrides.get(props.id);
  if (!overs) {
    return;
  }

  overs.forEach(function (value, valuePath) {
    recursiveSet(props, valuePath, value);
    // Invalidate data array if we have a data override
    if (valuePath[0] === 'data') {
      props.data = [].concat(_toConsumableArray(props.data));
    }
  });
};

/**
 * Listen for deck.gl edit events
 */
var layerEditListener = exports.layerEditListener = function layerEditListener(cb) {
  if (!_seer2.default.isReady()) {
    return;
  }

  _seer2.default.listenFor('deck.gl', cb);
};

/**
 * Listen for seer init events to resend data
 */
var seerInitListener = exports.seerInitListener = function seerInitListener(cb) {
  if (!_seer2.default.isReady()) {
    return;
  }

  _seer2.default.listenFor('init', cb);
};

/**
 * On finalyze of a specify layer, remove it from seer
 */
var removeLayerInSeer = exports.removeLayerInSeer = function removeLayerInSeer(id) {
  if (!_seer2.default.isReady() || !id) {
    return;
  }

  _seer2.default.deleteItem('deck.gl', id);
};

var logPayload = exports.logPayload = function logPayload(layer) {
  var data = [{ path: 'objects.props', data: layer.props }];

  var badges = [layer.constructor.layerName];

  if (layer.state) {
    if (layer.state.attributeManager) {
      var attrs = layer.state.attributeManager.getAttributes();
      data.push({ path: 'objects.attributes', data: attrs });
      badges.push(layer.state.attributeManager.stats.getTimeString());
    }
    if (layer.state.model) {
      layer.state.model.timerQueryEnabled = true;
      var lastFrameTime = layer.state.model.stats.lastFrameTime;

      if (lastFrameTime) {
        badges.push((lastFrameTime * 1000).toFixed(0) + '\u03BCs');
      }
    }
  }

  data.push({ path: 'badges', data: badges });

  return data;
};

var initLayerInSeer = exports.initLayerInSeer = function initLayerInSeer(layer) {
  if (!_seer2.default.isReady() || !layer) {
    return;
  }

  var badges = [layer.constructor.layerName];

  _seer2.default.listItem('deck.gl', layer.id, {
    badges: badges,
    links: layer.state && layer.state.model ? ['luma.gl:' + layer.state.model.id] : undefined,
    parent: layer.parentLayer ? layer.parentLayer.id : undefined
  });
};

/**
 * Log layer's properties to Seer
 */
var updateLayerInSeer = exports.updateLayerInSeer = function updateLayerInSeer(layer) {
  if (!_seer2.default.isReady() || _seer2.default.throttle('deck.gl:' + layer.id, 1E3)) {
    return;
  }

  var data = logPayload(layer);
  _seer2.default.multiUpdate('deck.gl', layer.id, data);
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9kZWJ1Zy9zZWVyLWludGVncmF0aW9uLmpzIl0sIm5hbWVzIjpbInJlY3Vyc2l2ZVNldCIsIm9iaiIsInBhdGgiLCJ2YWx1ZSIsImxlbmd0aCIsInNsaWNlIiwib3ZlcnJpZGVzIiwiTWFwIiwic2V0UHJvcE92ZXJyaWRlcyIsImlkIiwidmFsdWVQYXRoIiwiaXNSZWFkeSIsImhhcyIsInNldCIsInByb3BzIiwiZ2V0IiwiYXBwbHlQcm9wT3ZlcnJpZGVzIiwib3ZlcnMiLCJmb3JFYWNoIiwiZGF0YSIsImxheWVyRWRpdExpc3RlbmVyIiwibGlzdGVuRm9yIiwiY2IiLCJzZWVySW5pdExpc3RlbmVyIiwicmVtb3ZlTGF5ZXJJblNlZXIiLCJkZWxldGVJdGVtIiwibG9nUGF5bG9hZCIsImxheWVyIiwiYmFkZ2VzIiwiY29uc3RydWN0b3IiLCJsYXllck5hbWUiLCJzdGF0ZSIsImF0dHJpYnV0ZU1hbmFnZXIiLCJhdHRycyIsImdldEF0dHJpYnV0ZXMiLCJwdXNoIiwic3RhdHMiLCJnZXRUaW1lU3RyaW5nIiwibW9kZWwiLCJ0aW1lclF1ZXJ5RW5hYmxlZCIsImxhc3RGcmFtZVRpbWUiLCJ0b0ZpeGVkIiwiaW5pdExheWVySW5TZWVyIiwibGlzdEl0ZW0iLCJsaW5rcyIsInVuZGVmaW5lZCIsInBhcmVudCIsInBhcmVudExheWVyIiwidXBkYXRlTGF5ZXJJblNlZXIiLCJ0aHJvdHRsZSIsIm11bHRpVXBkYXRlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7Ozs7Ozs7O0FBQ0E7OztBQUdBLElBQU1BLGVBQWUsU0FBZkEsWUFBZSxDQUFDQyxHQUFELEVBQU1DLElBQU4sRUFBWUMsS0FBWixFQUFzQjtBQUN6QyxNQUFJLENBQUNGLEdBQUwsRUFBVTtBQUNSO0FBQ0Q7O0FBRUQsTUFBSUMsS0FBS0UsTUFBTCxHQUFjLENBQWxCLEVBQXFCO0FBQ25CSixpQkFBYUMsSUFBSUMsS0FBSyxDQUFMLENBQUosQ0FBYixFQUEyQkEsS0FBS0csS0FBTCxD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QixFQUFxQyxHQUFyQyxDQUF2QixFQUFrRTtBQUNoRTtBQUNEOztBQUVELE1BQU1VLE9BQU9PLFdBQVdDLEtBQVgsQ0FBYjtBQUNBLGlCQUFLdUIsV0FBTCxDQUFpQixTQUFqQixFQUE0QnZCLE1BQU1sQixFQUFsQyxFQUFzQ1UsSUFBdEM7QUFDRCxDQVBNIiwiZmlsZSI6InNlZXItaW50ZWdyYXRpb24uanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgc2VlciBmcm9tICdzZWVyJztcbi8qKlxuICogUmVjdXJzaXZlbHkgc2V0IGEgbmVzdGVkIHByb3BlcnR5IG9mIGFuIG9iamVjdCBnaXZlbiBhIHByb3BlcnRpZXMgYXJyYXkgYW5kIGEgdmFsdWVcbiAqL1xuY29uc3QgcmVjdXJzaXZlU2V0ID0gKG9iaiwgcGF0aCwgdmFsdWUpID0+IHtcbiAgaWYgKCFvYmopIHtcbiAgICByZXR1cm47XG4gIH1cblxuICBpZiAocGF0aC5sZW5ndGggPiAxKSB7XG4gICAgcmVjdXJzaXZlU2V0KG9ialtwYXRoWzBdXSwgcGF0aC5zbGljZSgxKSwgdmFsdWUpO1xuICB9IGVsc2Uge1xuICAgIG9ialtwYXRoWzBdXSA9IHZhbHVlO1xuICB9XG59O1xuXG5jb25zdCBvdmVycmlkZXMgPSBuZXcgTWFwKCk7XG5cbi8qKlxuICogQ3JlYXRlIGFuIG92ZXJyaWRlIG9uIHRoZSBzcGVjaWZ5IGxheWVyLCBpbmRleGVkIGJ5IGEgdmFsdWVQYXRoIGFycmF5LlxuICogRG8gbm90aGluZyBpbiBjYXNlIFNlZXIgYXMgbm90IGJlZW4gaW5pdGlhbGl6ZWQgdG8gcHJldmVudCBhbnkgcHJlZm9ybWFuY2UgZHJhd2JhY2suXG4gKi9cbmV4cG9ydCBjb25zdCBzZXRQcm9wT3ZlcnJpZGVzID0gKGlkLCB2YWx1ZVBhdGgsIHZhbHVlKSA9PiB7XG4gIGlmICghc2Vlci5pc1JlYWR5KCkpIHtcbiAgICByZXR1cm47XG4gIH1cblxuICBpZiAoIW92ZXJyaWRlcy5oYXMoaWQpKSB7XG4gICAgb3ZlcnJpZGVzLnNldChpZCwgbmV3IE1hcCgpKTtcbiAgfVxuXG4gIGNvbnN0IHByb3BzID0gb3ZlcnJpZGVzLmdldChpZCk7XG4gIHByb3BzLnNldCh2YWx1ZVBhdGgsIHZhbHVlKTtcbn07XG5cbi8qKlxuICogR2V0IHRoZSBwcm9wcyBvdmVycmlkZXMgb2YgYSBzcGVjaWZpYyBsYXllciBpZiBTZWVyIGFzIGJlZW4gaW5pdGlhbGl6ZWRcbiAqIEludmFsaWRhdGVzIHRoZSBkYXRhIHRvIGJlIHN1cmUgbmV3IG9uZXMgYXJlIGFsd2F5cyBwaWNrZWQgdXAuXG4gKi9cbmV4cG9ydCBjb25zdCBhcHBseVByb3BPdmVycmlkZXMgPSBwcm9wcyA9PiB7XG4gIGlmICghc2Vlci5pc1JlYWR5KCkgfHwgIXByb3BzLmlkKSB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgY29uc3Qgb3ZlcnMgPSBvdmVycmlkZXMuZ2V0KHByb3BzLmlkKTtcbiAgaWYgKCFvdmVycykge1xuICAgIHJldHVybjtcbiAgfVxuXG4gIG92ZXJzLmZvckVhY2goKHZhbHVlLCB2YWx1ZVBhdGgpID0+IHtcbiAgICByZWN1cnNpdmVTZXQocHJvcHMsIHZhbHVlUGF0aCwgdmFsdWUpO1xuICAgIC8vIEludmFsaWRhdGUgZGF0YSBhcnJheSBpZiB3ZSBoYXZlIGEgZGF0YSBvdmVycmlkZVxuICAgIGlmICh2YWx1ZVBhdGhbMF0gPT09ICdkYXRhJykge1xuICAgICAgcHJvcHMuZGF0YSA9IFsuLi5wcm9wcy5kYXRhXTtcbiAgICB9XG4gIH0pO1xufTtcblxuLyoqXG4gKiBMaXN0ZW4gZm9yIGRlY2suZ2wgZWRpdCBldmVudHNcbiAqL1xuZXhwb3J0IGNvbnN0IGxheWVyRWRpdExpc3RlbmVyID0gY2IgPT4ge1xuICBpZiAoIXNlZXIuaXNSZWFkeSgpKSB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgc2Vlci5saXN0ZW5Gb3IoJ2RlY2suZ2wnLCBjYik7XG59O1xuXG4vKipcbiAqIExpc3RlbiBmb3Igc2VlciBpbml0IGV2ZW50cyB0byByZXNlbmQgZGF0YVxuICovXG5leHBvcnQgY29uc3Qgc2VlckluaXRMaXN0ZW5lciA9IGNiID0+IHtcbiAgaWYgKCFzZWVyLmlzUmVhZHkoKSkge1xuICAgIHJldHVybjtcbiAgfVxuXG4gIHNlZXIubGlzdGVuRm9yKCdpbml0JywgY2IpO1xufTtcblxuLyoqXG4gKiBPbiBmaW5hbHl6ZSBvZiBhIHNwZWNpZnkgbGF5ZXIsIHJlbW92ZSBpdCBmcm9tIHNlZXJcbiAqL1xuZXhwb3J0IGNvbnN0IHJlbW92ZUxheWVySW5TZWVyID0gaWQgPT4ge1xuICBpZiAoIXNlZXIuaXNSZWFkeSgpIHx8ICFpZCkge1xuICAgIHJldHVybjtcbiAgfVxuXG4gIHNlZXIuZGVsZXRlSXRlbSgnZGVjay5nbCcsIGlkKTtcbn07XG5cbmV4cG9ydCBjb25zdCBsb2dQYXlsb2FkID0gbGF5ZXIgPT4ge1xuICBjb25zdCBkYXRhID0gW1xuICAgIHtwYXRoOiAnb2JqZWN0cy5wcm9wcycsIGRhdGE6IGxheWVyLnByb3BzfVxuICBdO1xuXG4gIGNvbnN0IGJhZGdlcyA9IFtsYXllci5jb25zdHJ1Y3Rvci5sYXllck5hbWVdO1xuXG4gIGlmIChsYXllci5zdGF0ZSkge1xuICAgIGlmIChsYXllci5zdGF0ZS5hdHRyaWJ1dGVNYW5hZ2VyKSB7XG4gICAgICBjb25zdCBhdHRycyA9IGxheWVyLnN0YXRlLmF0dHJpYnV0ZU1hbmFnZXIuZ2V0QXR0cmlidXRlcygpO1xuICAgICAgZGF0YS5wdXNoKHtwYXRoOiAnb2JqZWN0cy5hdHRyaWJ1dGVzJywgZGF0YTogYXR0cnN9KTtcbiAgICAgIGJhZGdlcy5wdXNoKGxheWVyLnN0YXRlLmF0dHJpYnV0ZU1hbmFnZXIuc3RhdHMuZ2V0VGltZVN0cmluZygpKTtcbiAgICB9XG4gICAgaWYgKGxheWVyLnN0YXRlLm1vZGVsKSB7XG4gICAgICBsYXllci5zdGF0ZS5tb2RlbC50aW1lclF1ZXJ5RW5hYmxlZCA9IHRydWU7XG4gICAgICBjb25zdCB7bGFzdEZyYW1lVGltZX0gPSBsYXllci5zdGF0ZS5tb2RlbC5zdGF0cztcbiAgICAgIGlmIChsYXN0RnJhbWVUaW1lKSB7XG4gICAgICAgIGJhZGdlcy5wdXNoKGAkeyhsYXN0RnJhbWVUaW1lICogMTAwMCkudG9GaXhlZCgwKX3OvHNgKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBkYXRhLnB1c2goe3BhdGg6ICdiYWRnZXMnLCBkYXRhOiBiYWRnZXN9KTtcblxuICByZXR1cm4gZGF0YTtcbn07XG5cbmV4cG9ydCBjb25zdCBpbml0TGF5ZXJJblNlZXIgPSBsYXllciA9PiB7XG4gIGlmICghc2Vlci5pc1JlYWR5KCkgfHwgIWxheWVyKSB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgY29uc3QgYmFkZ2VzID0gW2xheWVyLmNvbnN0cnVjdG9yLmxheWVyTmFtZV07XG5cbiAgc2Vlci5saXN0SXRlbSgnZGVjay5nbCcsIGxheWVyLmlkLCB7XG4gICAgYmFkZ2VzLFxuICAgIGxpbmtzOiBsYXllci5zdGF0ZSAmJiBsYXllci5zdGF0ZS5tb2RlbCA/IFtgbHVtYS5nbDoke2xheWVyLnN0YXRlLm1vZGVsLmlkfWBdIDogdW5kZWZpbmVkLFxuICAgIHBhcmVudDogbGF5ZXIucGFyZW50TGF5ZXIgPyBsYXllci5wYXJlbnRMYXllci5pZCA6IHVuZGVmaW5lZFxuICB9KTtcbn07XG5cbi8qKlxuICogTG9nIGxheWVyJ3MgcHJvcGVydGllcyB0byBTZWVyXG4gKi9cbmV4cG9ydCBjb25zdCB1cGRhdGVMYXllckluU2VlciA9IGxheWVyID0+IHtcbiAgaWYgKCFzZWVyLmlzUmVhZHkoKSB8fCBzZWVyLnRocm90dGxlKGBkZWNrLmdsOiR7bGF5ZXIuaWR9YCwgMUUzKSkge1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGNvbnN0IGRhdGEgPSBsb2dQYXlsb2FkKGxheWVyKTtcbiAgc2Vlci5tdWx0aVVwZGF0ZSgnZGVjay5nbCcsIGxheWVyLmlkLCBkYXRhKTtcbn07XG4iXX0=