{"version":3,"sources":["../../src/webgl/resource.js"],"names":["luma","assertWebGLContext","isWebGL2","glGet","glKey","uid","assert","polyfillContext","ERR_RESOURCE_METHOD_UNDEFINED","Resource","gl","opts","id","userData","ext","constructor","name","_handle","handle","undefined","_createHandle","_addStats","deleteChildren","children","_deleteHandle","filter","Boolean","forEach","child","delete","bind","pname","parameters","PARAMETERS","parameter","isWebgl2","parameterAvailable","getExtension","extension","webgl1Default","webgl1","webgl2Default","webgl2","defaultValue","_getParameter","keys","values","parameterKeys","Object","key","getParameter","type","value","Error","_setParameter","setParameter","stats","resourceCount","resourceMap","count"],"mappings":"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","file":"resource.js","sourcesContent":["import luma from '../init';\nimport {assertWebGLContext, isWebGL2} from './context';\nimport {glGet, glKey} from './gl-constants';\nimport {uid} from '../utils';\nimport assert from 'assert';\nimport {polyfillContext} from '../webgl-utils';\n\nconst ERR_RESOURCE_METHOD_UNDEFINED = 'Resource subclass must define virtual methods';\n\n// TODO - Handle context loss\n// function glGetContextLossCount(gl) {\n//   return (gl.luma && gl.luma.glCount) || 0;\n// }\n\nexport default class Resource {\n  constructor(gl, opts = {}) {\n    assertWebGLContext(gl);\n\n    const {id, userData = {}} = opts;\n    this.gl = gl;\n    this.ext = polyfillContext(gl);\n    this.id = id || uid(this.constructor.name);\n    this.userData = userData;\n    this.opts = opts;\n\n    // Set the handle\n    // If handle was provided, use it, otherwise create a new handle\n\n    // TODO - Stores the handle with context loss information\n    // this.glCount = glGetContextLossCount(this.gl);\n\n    // Default VertexArray needs to be created with null handle, so compare against undefined\n    this._handle = opts.handle;\n    if (this._handle === undefined) {\n      this._handle = this._createHandle();\n    }\n\n    this._addStats();\n  }\n\n  toString() {\n    return `${this.constructor.name}(${this.id})`;\n  }\n\n  get handle() {\n    // TODO - Add context loss handling\n    // Will regenerate and reinitialize the handle if necessary\n    // const glCount = glGetContextLossCount(this.gl);\n    // if (this.glCount !== glCount) {\n    //   this._handle = this._createHandle(this.opts);\n    //   this._glCount = glCount;\n    //   // Reinitialize object\n    //   this.initialize(this.opts);\n    // }\n    return this._handle;\n  }\n\n  delete({deleteChildren = false} = {}) {\n    // Delete this object, and get refs to any children\n    const children = this._handle && this._deleteHandle(this._handle);\n    this._handle = null;\n\n    // Optionally, recursively delete the children\n    if (children && deleteChildren) {\n      children.filter(Boolean).forEach(child => {\n        child.delete();\n      });\n    }\n\n    return this;\n  }\n\n  unbind() {\n    this.bind(null);\n  }\n\n  /**\n   * Query a Resource parameter\n   *\n   * @todo - cache parameters to avoid issuing WebGL calls?\n   *\n   * @param {GLenum} pname\n   * @return {GLint|GLfloat|GLenum} param\n   */\n  getParameter(pname, opts = {}) {\n    pname = glGet(pname);\n    assert(pname);\n\n    const parameters = this.constructor.PARAMETERS || {};\n\n    // Use parameter definitions to handle unsupported parameters\n    const parameter = parameters[pname];\n    if (parameter) {\n      const isWebgl2 = isWebGL2(this.gl);\n\n      // Check if we can query for this parameter\n      const parameterAvailable =\n        (!('webgl2' in parameter) || isWebgl2) &&\n        (!('extension' in parameter) || this.gl.getExtension(parameter.extension));\n\n      if (!parameterAvailable) {\n        const webgl1Default = parameter.webgl1;\n        const webgl2Default = 'webgl2' in parameter ? parameter.webgl2 : parameter.webgl1;\n        const defaultValue = isWebgl2 ? webgl2Default : webgl1Default;\n        return defaultValue;\n      }\n    }\n\n    // If unknown parameter - Could be a valid parameter not covered by PARAMS\n    // Attempt to query for it and let WebGL report errors\n    return this._getParameter(pname, opts);\n  }\n\n  // Many resources support a getParameter call -\n  // getParameters will get all parameters - slow but useful for debugging\n  getParameters(opts = {}) {\n    const {parameters, keys} = {};\n\n    // Get parameter definitions for this Resource\n    const PARAMETERS = this.constructor.PARAMETERS || {};\n\n    const isWebgl2 = isWebGL2(this.gl);\n\n    const values = {};\n\n    // Query all parameters if no list provided\n    const parameterKeys = parameters || Object.keys(PARAMETERS);\n\n    // WEBGL limits\n    for (const pname of parameterKeys) {\n      const parameter = PARAMETERS[pname];\n\n      // Check if this parameter is available on this platform\n      const parameterAvailable =\n        parameter &&\n        (!('webgl2' in parameter) || isWebgl2) &&\n        (!('extension' in parameter) || this.gl.getExtension(parameter.extension));\n\n      if (parameterAvailable) {\n        const key = keys ? glKey(pname) : pname;\n        values[key] = this.getParameter(pname, opts);\n        if (keys && parameter.type === 'GLenum') {\n          values[key] = glKey(values[key]);\n        }\n      }\n    }\n\n    return values;\n  }\n\n  /**\n   * Update a Resource setting\n   *\n   * @todo - cache parameter to avoid issuing WebGL calls?\n   *\n   * @param {GLenum} pname - parameter (GL constant, value or key)\n   * @param {GLint|GLfloat|GLenum} value\n   * @return {Resource} returns self to enable chaining\n   */\n  setParameter(pname, value) {\n    pname = glGet(pname);\n    assert(pname);\n\n    const parameters = this.constructor.PARAMETERS || {};\n\n    const parameter = parameters[pname];\n    if (parameter) {\n      const isWebgl2 = isWebGL2(this.gl);\n\n      // Check if this parameter is available on this platform\n      const parameterAvailable =\n        (!('webgl2' in parameter) || isWebgl2) &&\n        (!('extension' in parameter) || this.gl.getExtension(parameter.extension));\n\n      if (!parameterAvailable) {\n        throw new Error('Parameter not available on this platform');\n      }\n\n      // Handle string keys\n      if (parameter.type === 'GLenum') {\n        value = glGet(value);\n      }\n    }\n\n    // If unknown parameter - Could be a valid parameter not covered by PARAMS\n    // attempt to set it and let WebGL report errors\n    this._setParameter(pname, value);\n    return this;\n  }\n\n  /*\n   * Batch update resource parameters\n   * Assumes the subclass supports a setParameter call\n   */\n  setParameters(parameters) {\n    for (const pname in parameters) {\n      this.setParameter(pname, parameters[pname]);\n    }\n    return this;\n  }\n\n  // PUBLIC VIRTUAL METHODS\n  initialize(opts) {\n  }\n\n  // PROTECTED METHODS - These must be overridden by subclass\n  _createHandle() {\n    throw new Error(ERR_RESOURCE_METHOD_UNDEFINED);\n  }\n\n  _deleteHandle() {\n    throw new Error(ERR_RESOURCE_METHOD_UNDEFINED);\n  }\n\n  _getOptsFromHandle() {\n    throw new Error(ERR_RESOURCE_METHOD_UNDEFINED);\n  }\n\n  _getParameter(pname, opts) {\n    throw new Error(ERR_RESOURCE_METHOD_UNDEFINED);\n  }\n\n  /**\n   * @param {GLenum} pname\n   * @param {GLint|GLfloat|GLenum} param\n   * @return {Sampler} returns self to enable chaining\n   */\n  _setParameter(pname, value) {\n    throw new Error(ERR_RESOURCE_METHOD_UNDEFINED);\n  }\n\n  // PRIVATE METHODS\n\n  _context() {\n    this.gl.luma = this.gl.luma || {};\n    return this.gl.luma;\n  }\n\n  _addStats() {\n    const name = this.constructor.name;\n\n    const {stats} = luma;\n    stats.resourceCount = stats.resourceCount || 0;\n    stats.resourceMap = stats.resourceMap || {};\n\n    // Resource creation stats\n    stats.resourceCount++;\n    stats.resourceMap[name] = stats.resourceMap[name] || {count: 0};\n    stats.resourceMap[name].count++;\n  }\n}\n"]}